<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>LED configuration page</title>
    <script src="iro.min.js"></script>
    <script type="application/javascript">

        document.addEventListener("DOMContentLoaded", function() {
            start()

            for(let s of document.getElementsByClassName("source")) {
                s.addEventListener("click", sourceMessage)
            }
            for(let s of document.getElementsByClassName("special")) {
                s.addEventListener("click", textMessage)
            }
        });

        let state = {{state}}

        function start() {
            initColorPicker()
            updateState()
        }

        function updateState() {
            let sources = document.getElementsByClassName("source")
            for(let s of sources) {
                s.className = "source unselected"
            }
            document.getElementById(state.source).className = "source selected"
            document.getElementById("hsl_color").value = state.color
            document.getElementById("msg").value = messages[message_index]
        }

        function initColorPicker() {
            let colorPicker = new iro.ColorPicker('#picker', {
                width: 180,
                layoutDirection: "horizontal",
                layout: [
                    { 
                        component: iro.ui.Wheel,
                        options: {
                            wheelLightness: false
                        }
                    },
                    {
                        component: iro.ui.Box,
                        options: {}
                    }

                ]
            });
            colorPicker.color.hexString = state.color;
            let colorInput = document.getElementById("hsl_color")
            colorPicker.on('color:change', function(color) {
                //console.log("Picker updated: " + color.hexString)
                colorInput.value = color.hexString.toUpperCase();
            })
            colorInput.addEventListener("change", function(event) {
                colorPicker.color.hexString = colorInput.value
            })

        }

        function sourceMessage(event) {
            let source = event.target.id
            let url = "source/" + source
            state.source = source
            if(source === "color") {
                let color = document.getElementById("hsl_color").value
                url += "?" + color.substr(1)
                state.color = color
            }
            fetch( url, {
                method: 'GET',                
            })
            .then(response => response.json())
            .then(data => {
                if(data.result != "ok") {
                    alert("Error communicating with sever")
                }
                else {
                    console.log("Message sent")
                    updateState()
                }
            })
            .catch((error) => {
                alert('Error:' + error);
            });
        }

        let message_index = 0
        let messages = [
            "AHOJ URSULO",
            "HLEDEJ U HEDVIKY",
            "TAK MOZNA V KOUPELNE",
            "U KLAVIRU VLASTNE"
        ]

        function textMessage(event) {
            let txt = event.target.value
            if(event.target.id == "morsetext") {
                txt = document.getElementById("msg").value
                message_index = (message_index + 1) % messages.length
                updateState()
            }
            let url = "msg/" + event.target.id.toUpperCase() + "?" + txt
            fetch(url, {method: 'GET'})
            .then(response => response.json())
            .textMessage(data => { console.log(data)})
            .catch((error) => { alert('Error ' + error)})
        }
    </script>
    <style type="text/css">
        div#iro {
            display: flex;
            flex-direction: column;
        }
        div#sources {
            display: flex;
            flex-direction: row;
            max-width: 100%;
            flex-wrap: wrap;
        }
        button.source {
            min-width: 180px;
            min-height: 100px;
            width: 20vw;
            height: 15vh;
            margin: 1vw;
            font-size: 150%;
        }

        button.unselected {
            background-color: slategrey;
        }

        button.selected {
            background-color: lightgray;
        }

    </style>
</head>
<body>
<div>
    <div id="sources">
        <button class="source unselected" id="embers">Fire</button>
        <button class="source unselected" id="perlin">Sky</button>
        <button class="source unselected" id="color">Colour</button>
        <button class="source unselected" id="chaser">Chaser</button>
        <button class="source unselected" id="off">Off</button>
        <button class="source unselected" id="morse">Off</button>
    </div>
    <div id="iro">
        <div id="picker"></div>
        <input type="text" id="hsl_color" value="#ffffff">
    </div>
    <div>
        <input type="text" id="msg" value="TOTO JE POKUS">
        <button class="special" id="morsetext">Text</button>
        <button class="special" id="morsemode" value="0">Morse scroll</button>
        <button class="special" id="morsemode" value="1">Text scroll</button>
        <button class="special" id="morsemode" value="2">Morse blink</button>
        <button class="special" id="morsemode" value="3">Cycle</button>
    </div>
    <div id="systeminfo">
        {{systeminfo}}
    </div>
</div>


</body>
</html>
