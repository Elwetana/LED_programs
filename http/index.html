<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>LED configuration page</title>
    <script type="application/javascript">

        document.addEventListener("DOMContentLoaded", function() {
            start()
            document.getElementById("hue_input").addEventListener("change", updateLS)
            document.getElementById("saturation_input").addEventListener("change", paintLightnessCanvas)
            document.getElementById("lightness_input").addEventListener("change", paintSaturationCanvas)

            let canvases = document.getElementsByClassName("hsl_canvas")
            for(let c of canvases){
                c.addEventListener("touchstart", touchStartHSL)
                c.addEventListener("touchmove", touchMoveHSL)
                c.addEventListener("touchend", touchEndHSL)
            }

            let sources = document.getElementsByClassName("source")
            for(let s of sources) {
                s.addEventListener("click", sourceMessage)
            }
        });

        function start() {
            paintHueCanvas()
            updateLS()
        }
//#region HSL stuff
        let touchHandler = (function(){
            let handler = {}
            let savedRect = {}
            handler.storeRect = function(event) {
                let touch = event.touches[0]
                let canvas = touch.target
                var rect = canvas.getBoundingClientRect();
                let x = touch.clientX - rect.left
                let y = touch.clientY - rect.top
                console.log(canvas.id, x, y)
                let id = canvas.id
                let ctx = canvas.getContext('2d')
                savedRect.id = {
                    data: ctx.getImageData(x - 16, y - 16, 32, 32),
                    x: x,
                    y: y
                }
                ctx.strokeStyle = "black"
                ctx.lineWidth = 2
                ctx.beginPath()
                ctx.arc(x, y, 14, 0, 2*Math.PI)
                ctx.stroke()
                return x / rect.width
            }
            handler.restoreRect = function(event) {
                let canvas = event.target
                let id = canvas.id
                let ctx = canvas.getContext('2d')
                ctx.putImageData(savedRect.id.data, savedRect.id.x - 16, savedRect.id.y - 16)
            }
            return handler
        })()

        function handleTouch(fx, id) {
            if(id === "hue_canvas") {
                let hue = fx * 360
            }
        }

        function touchStartHSL(event) {
            let fx = touchHandler.storeRect(event);
            handleTouch(fx, event.target.id)
        }
        function touchMoveHSL(event) {
            touchHandler.restoreRect(event)
            let fx = touchHandler.storeRect(event);
            handleTouch(fx, event.target.id)
        }
        function touchEndHSL(event) {
            touchHandler.restoreRect(event)
        }

        function paintHSLCanvas(canvasId, type) {
            let h = parseInt(document.getElementById("hue_input").value)/360.0
            let s = parseInt(document.getElementById("saturation_input").value)/100.0
            let l = parseInt(document.getElementById("lightness_input").value)/100.0
            //console.log(h, s, l, type)

            let canvas = document.getElementById(canvasId)
            let ctx = canvas.getContext('2d')
            let xRange = canvas.clientWidth
            let height = canvas.clientHeight
            canvas.width = xRange
            canvas.height = height
            ctx.clearRect(0, 0, xRange, height)
            for(let x = 0; x < xRange; x++) {
                ctx.beginPath()
                let color = "";
                if(type === "H") color = hsl2rgb(x/xRange, 1, 0.5)
                if(type === "S") color = hsl2rgb(h, x/xRange, l)
                if(type === "L") color = hsl2rgb(h, s, x/xRange)
                ctx.strokeStyle = color
                //console.log(x/xRange, color)
                ctx.moveTo(x, 0)
                ctx.lineTo(x, height - 1)
                ctx.stroke()
            }

            canvas = document.getElementById("result_canvas")
            ctx = canvas.getContext('2d')
            ctx.fillStyle = hsl2rgb(h, s, l)
            ctx.fillRect(0, 0, canvas.clientWidth, canvas.clientHeight)

            document.getElementById("hsl_color").value = hsl2rgb(h, s, l)
        }

        function paintHueCanvas() {
            paintHSLCanvas("hue_canvas", "H")
        }

        function updateLS() {
            paintLightnessCanvas()
            paintSaturationCanvas()
        }

        function paintLightnessCanvas() {
            paintHSLCanvas("lightness_canvas", "L")
        }

        function paintSaturationCanvas() {
            paintHSLCanvas("saturation_canvas", "S")
        }

        /**
         * All parameters are 0 - 1, including hue
         */
        function hsl2rgb(h, s, l) {
            //copy & paste from Python Colour package
            function formatColor(rgb) {
                let s = "#"
                for(c of rgb) {
                    cc = Math.round(255 * c).toString(16).toUpperCase();
                    if(cc.length === 1) {
                        cc = "0" + cc
                    }
                    s += cc
                }
                return s
            }

            function _hue2rgb(v1, v2, vH) {
                while(vH < 0) vH += 1;
                while(vH > 1) vH -= 1;

                if(6 * vH < 1) return v1 + (v2 - v1) * 6 * vH;
                if(2 * vH < 1) return v2
                if(3 * vH < 2) return v1 + (v2 - v1) * ((2.0 / 3) - vH) * 6

                return v1
            }

            FLOAT_ERROR = 0.0000005
            if((0.0 - FLOAT_ERROR > s) || (s > 1.0 + FLOAT_ERROR)) {
                console.log("Saturation must be between 0 and 1.")
                return "#000000"
            }
            if((0.0 - FLOAT_ERROR > l) || (l > 1.0 + FLOAT_ERROR)) {
                console.log("Lightness must be between 0 and 1.")
                return "#000011"
            }

            if(s == 0) {
                return formatColor([l, l, l])
            }

            let v2 = 0
            if(l < 0.5) {
                v2 = l * (1.0 + s)
            }
            else {
                v2 = (l + s) - (s * l)
            }

            let v1 = 2.0 * l - v2

            r = _hue2rgb(v1, v2, h + (1.0 / 3))
            g = _hue2rgb(v1, v2, h)
            b = _hue2rgb(v1, v2, h - (1.0 / 3))

            return formatColor([r, g, b])
        }
//#endregion

        function sourceMessage(event) {
            let url = "index.html/" + event.target.id
            if(event.target.id === "color") {
                url += "?" + document.getElementById("hsl_color").value.substr(1)
            }
            console.log(url)
            fetch( url, {
                method: 'GET',                
            })
            .then(response => response.json())
            .then(data => {
                if(data.result != "ok") {
                    alert("Error communicating with sever")
                }
                else {
                    console.log("Message sent")
                }
            })
            .catch((error) => {
                alert('Error:' + error);
            });
        }
    </script>
    <style type="text/css">
        div#common_controls {
            display: flex;
            flex-direction: column;
        }
        input.hsl_input {
            width: 360px;
        }
        canvas.hsl_canvas {
            width: 360px;
            height: 100px;
        }
        input#hsl_color {
            width: 200px;
        }

        div#sources {
            display: flex;
            flex-direction: row;
            max-width: 100%;
            flex-wrap: wrap;
        }
        button.source {
            min-width: 200px;
            min-height: 150px;
            width: 20vw;
            height: 20vh;
            margin: 1vw;
            font-size: 150%;
            background-color: slategrey;
        }

    </style>
</head>
<body>
<div>
    <div id="sources">
        <button class="source" id="embers">Fire</button>
        <button class="source" id="perlin">Sky</button>
        <button class="source" id="color">Colour</button>
        <button class="source" id="off">Off</button>
    </div>
    <div id="common_controls">
        <canvas id="hue_canvas" class="hsl_canvas"></canvas>
        <input type="range" class="hsl_input" id="hue_input" min="0" max="360">
        <label for="hue_input">Hue</label>
        <canvas id="lightness_canvas" class="hsl_canvas"></canvas>
        <input type="range" class="hsl_input" id="lightness_input" min="0" max="100">
        <label for="lightness_input">Lightness</label>
        <canvas id="saturation_canvas" class="hsl_canvas"></canvas>
        <input type="range" class="hsl_input" id="saturation_input" min="0" max="100">
        <label for="saturation_input">Saturation</label>
        <canvas id="result_canvas" class="hsl_canvas"></canvas>
        <input type="text" id="hsl_color">
    </div>
</div>


</body>
</html>